// js/main.js
import { stateManager } from './state/stateManager.js';
import { updateAuthUI } from './views/auth.js';

// Sistema de navega√ß√£o por show/hide
export function renderView(viewName) {
    console.log('üîÑ Navegando para:', viewName);
    
    // Esconder todas as sections
    document.querySelectorAll('.page-section').forEach(section => {
        section.classList.add('hidden');
        section.classList.remove('active-page');
    });

    // Mostrar section alvo
    const targetSection = document.getElementById(viewName);
    if (targetSection) {
        targetSection.classList.remove('hidden');
        targetSection.classList.add('active-page');
        
        // Atualizar √≠cones Lucide
        if (window.lucide) {
            lucide.createIcons();
        }
        
        // Inicializar listeners espec√≠ficos da view
        initViewListeners(viewName);
    } else {
        console.error('‚ùå Section n√£o encontrada:', viewName);
    }
}

// Inicializar listeners espec√≠ficos por p√°gina
function initViewListeners(viewName) {
    console.log('üéØ Inicializando listeners para:', viewName);
    
    switch (viewName) {
        case 'login-page':
            initAuthPageListeners();
            break;
        case 'search-page':
            initSearchListeners();
            break;
        case 'booking-page':
            initBookingListeners();
            break;
        case 'admin-dashboard-page':
            import('./views/adminDashboard.js').then(module => {
                if (module.initAdminDashboardListeners) {
                    module.initAdminDashboardListeners();
                }
            });
            break;
        case 'professional-dashboard-page':
            import('./views/profissionalDashboard.js').then(module => {
                if (module.initProfessionalDashboardListeners) {
                    module.initProfessionalDashboardListeners();
                }
            });
            break;
    }
}

function initAuthPageListeners() {
    console.log('üéØ Inicializando listeners da p√°gina de auth');
    // Os formul√°rios j√° usam onsubmit, ent√£o n√£o precisamos adicionar listeners aqui
}

function initSearchListeners() {
    console.log('üéØ Inicializando listeners de busca');
    
    const searchInput = document.getElementById('search-input');
    const searchButton = document.querySelector('[onclick="performSearch()"]');
    
    if (searchInput && searchButton) {
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
}

function initBookingListeners() {
    console.log('üéØ Inicializando listeners de agendamento');
    
    // Atualizar resumo em tempo real
    const bookingService = document.getElementById('booking-service');
    const bookingDate = document.getElementById('booking-date');
    const bookingTime = document.getElementById('booking-time');
    
    if (bookingService) {
        bookingService.addEventListener('change', updateBookingSummary);
    }
    if (bookingDate) {
        bookingDate.addEventListener('change', updateBookingSummary);
    }
    if (bookingTime) {
        bookingTime.addEventListener('change', updateBookingSummary);
    }
}

// Fun√ß√µes de agendamento
function updateBookingSummary() {
    const service = document.getElementById('booking-service')?.value;
    const date = document.getElementById('booking-date')?.value;
    const time = document.getElementById('booking-time')?.value;

    const summaryService = document.getElementById('summary-service');
    const summaryDate = document.getElementById('summary-date');
    const summaryTime = document.getElementById('summary-time');
    const summaryPrice = document.getElementById('summary-price');

    if (summaryService) summaryService.textContent = service || '-';
    if (summaryDate) summaryDate.textContent = date ? new Date(date).toLocaleDateString('pt-BR') : '-';
    if (summaryTime) summaryTime.textContent = time || '-';
    if (summaryPrice) summaryPrice.textContent = getServicePrice(service) || '-';
}

function getServicePrice(service) {
    const prices = {
        'Corte Masculino': '1.800 MT',
        'Barba': '1.000 MT',
        'Corte + Barba': '2.400 MT'
    };
    return prices[service] || 'A combinar';
}

// ========== CR√çTICO: EXPOR FUN√á√ïES GLOBAIS ==========

// Fun√ß√µes globais para navega√ß√£o
window.renderView = renderView;

window.viewProfessional = function(professionalId) {
    console.log('Ver profissional:', professionalId);
    stateManager.state.bookingProfessionalId = professionalId;
    renderView('professional-profile-page');
};

window.startBooking = function(professionalId) {
    console.log('Iniciar agendamento para:', professionalId);
    if (!stateManager.state.currentUser) {
        alert('Por favor, fa√ßa login para agendar um servi√ßo.');
        renderView('login-page');
        return;
    }
    stateManager.state.bookingProfessionalId = professionalId;
    renderView('booking-page');
};

window.showRegisterForm = function() {
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    
    if (loginForm && registerForm) {
        loginForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
    }
};

window.showLoginForm = function() {
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    
    if (loginForm && registerForm) {
        registerForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
    }
};

// Fun√ß√µes de navega√ß√£o espec√≠ficas
window.switchAppointmentTab = function(tab) {
    console.log(`Alternando para aba de agendamentos: ${tab}`);
    // Implementar l√≥gica de altern√¢ncia de abas
    document.querySelectorAll('[onclick*="switchAppointmentTab"]').forEach(btn => {
        btn.classList.remove('border-black', 'text-black', 'font-medium');
        btn.classList.add('text-gray-600');
    });
    
    const activeBtn = document.querySelector(`[onclick*="switchAppointmentTab('${tab}')"]`);
    if (activeBtn) {
        activeBtn.classList.add('border-black', 'text-black', 'font-medium');
        activeBtn.classList.remove('text-gray-600');
    }
};

window.switchAdminTab = function(tab) {
    stateManager.setAdminTab(tab);
    renderView('admin-dashboard-page');
};

window.switchProfessionalTab = function(tab) {
    stateManager.setProfessionalTab(tab);
    renderView('professional-dashboard-page');
};

// Fun√ß√µes de busca
window.performSearch = function() {
    const searchTerm = document.getElementById('search-input')?.value;
    console.log(`Buscando por: ${searchTerm}`);
    alert(`Buscando por: ${searchTerm}`);
};

window.showFilters = function() {
    console.log('Mostrar filtros de busca');
    alert('Mostrar filtros de busca');
};

// Fun√ß√µes de agendamento
window.confirmBooking = function(event) {
    if (event) event.preventDefault();
    
    const service = document.getElementById('booking-service')?.value;
    const date = document.getElementById('booking-date')?.value;
    const time = document.getElementById('booking-time')?.value;
    
    if (!service || !date || !time) {
        alert('Por favor, preencha todos os campos obrigat√≥rios.');
        return;
    }
    
    alert(`üìÖ Agendamento confirmado para ${date} √†s ${time}`);
    renderView('appointments-page');
};

// Logout
window.handleLogout = function() {
    stateManager.setCurrentUser(null);
    updateAuthUI();
    renderView('home-page');
};

// Fun√ß√µes para a√ß√µes do admin
window.approveRegistration = function(registrationId) {
    if (stateManager.approveProfessionalRegistration(registrationId)) {
        alert('‚úÖ Cadastro aprovado com sucesso!');
        renderView('admin-dashboard-page');
    } else {
        alert('‚ùå Erro ao aprovar cadastro.');
    }
};

window.openRejectModal = function(registrationId) {
    alert(`Abrir modal para rejeitar cadastro: ${registrationId}`);
};

window.viewSalonDetails = function(salonId) {
    alert(`Ver detalhes do sal√£o: ${salonId}`);
};

// Fun√ß√µes para a√ß√µes do profissional
window.viewAppointmentDetails = function(appointmentId) {
    alert(`Ver detalhes do agendamento: ${appointmentId}`);
};

window.markAppointmentAsCompleted = function(appointmentId) {
    if (confirm('Marcar este agendamento como conclu√≠do?')) {
        if (stateManager.updateAppointmentStatus(appointmentId, 'completed')) {
            alert('‚úÖ Agendamento marcado como conclu√≠do!');
            renderView('professional-dashboard-page');
        }
    }
};

window.cancelAppointment = function(appointmentId) {
    if (confirm('Tem certeza que deseja cancelar este agendamento?')) {
        if (stateManager.updateAppointmentStatus(appointmentId, 'cancelled')) {
            alert('‚ùå Agendamento cancelado.');
            renderView('professional-dashboard-page');
        }
    }
};

// Inicializa√ß√£o da aplica√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ WeCut iniciado');
    
    // Restaurar estado
    stateManager.restoreState();
    
    // Inicializar √≠cones
    if (window.lucide) {
        lucide.createIcons();
    }
    
    // Navega√ß√£o por data-view
    document.querySelectorAll('[data-view]').forEach(element => {
        element.addEventListener('click', function(e) {
            e.preventDefault();
            const targetView = this.getAttribute('data-view');
            renderView(targetView);
        });
    });
    
    // Logo -> Home
    const logo = document.getElementById('logo');
    if (logo) {
        logo.addEventListener('click', () => renderView('home-page'));
    }
    
    // Bot√µes de auth
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const logoutBtn = document.getElementById('logout-btn');
    
    if (loginBtn) loginBtn.addEventListener('click', () => renderView('login-page'));
    if (signupBtn) signupBtn.addEventListener('click', () => renderView('login-page'));
    if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
    
    // ========== CR√çTICO: IMPORTAR E EXPOR FUN√á√ïES DE AUTH ==========
    import('./views/auth.js').then(module => {
        console.log('‚úÖ M√≥dulo auth carregado');
        
        // Expor fun√ß√µes de autentica√ß√£o
        if (module.handleLogin) {
            window.handleLogin = module.handleLogin;
            console.log('‚úÖ handleLogin exposto globalmente');
        }
        
        if (module.handleRegister) {
            window.handleRegister = module.handleRegister;
            console.log('‚úÖ handleRegister exposto globalmente');
        }
        
        if (module.showRegisterForm) {
            window.showRegisterForm = module.showRegisterForm;
        }
        
        if (module.showLoginForm) {
            window.showLoginForm = module.showLoginForm;
        }
        
        // Verificar se as fun√ß√µes est√£o dispon√≠veis
        console.log('typeof window.handleLogin:', typeof window.handleLogin);
        console.log('typeof window.handleRegister:', typeof window.handleRegister);
        console.log('typeof window.renderView:', typeof window.renderView);
    }).catch(error => {
        console.error('‚ùå Erro ao carregar m√≥dulo auth:', error);
    });
    
    // Atualizar UI de autentica√ß√£o
    updateAuthUI();
    
    console.log('‚úÖ Inicializa√ß√£o completa');
    
    // Debug: verificar fun√ß√µes globais
    setTimeout(() => {
        console.log('=== VERIFICA√á√ÉO DE FUN√á√ïES GLOBAIS ===');
        console.log('handleLogin:', typeof window.handleLogin);
        console.log('handleRegister:', typeof window.handleRegister);
        console.log('renderView:', typeof window.renderView);
        console.log('performSearch:', typeof window.performSearch);
        console.log('viewProfessional:', typeof window.viewProfessional);
        console.log('startBooking:', typeof window.startBooking);
    }, 1000);
});